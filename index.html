<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Formulário</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    #form-container {
      background-color: #fff;
      color: #202124;
      max-width: 480px;
      width: 95%;
      padding: 1.5rem 2rem;
      box-shadow: 0 2px 8px rgb(0 0 0 / 0.2);
      border-radius: 8px;
      margin: 1rem;
    }
    h1, h2 {
      text-align: center;
      font-weight: 600;
      color: #202124;
    }
    label {
      display: block;
      margin-top: 1rem;
      font-weight: 600;
      font-size: 1rem;
    }
    input, select, textarea {
      width: 100%;
      padding: 0.4rem 0.6rem;
      font-size: 1rem;
      margin-top: 0.3rem;
      border: 1px solid #dadce0;
      border-radius: 4px;
      box-sizing: border-box;
    }
    textarea {
      resize: vertical;
    }
    button {
      background-color: #247019;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.6rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      margin: 0.5rem 0.3rem;
      min-width: 110px;
    }
    button:hover {
      background-color: #b1271b;
    }
    #btn-coords {
      display: block;
      margin: 0.7rem auto 0 auto;
      min-width: 140px;
    }
    #botoes-final {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    th, td {
      border: 1px solid #dadce0;
      padding: 0.4rem;
      text-align: left;
    }
    th {
      background-color: #f1f3f4;
      font-weight: bold;
    }
    .tabela-container {
      overflow-x: auto;
      margin-top: 1.5rem;
    }

    @media (max-width: 480px) {
      #form-container {
        padding: 1rem;
        width: 100%;
        box-shadow: none;
        border-radius: 0;
      }
      button {
        min-width: 100%;
        margin: 0.3rem 0;
      }
      #botoes-final {
        flex-direction: column;
        align-items: center;
      }
      #btn-coords {
        min-width: 100%;
        margin-bottom: 1rem;
      }
    }

    /* ✅ Correção para visualização responsiva das tabelas no celular */
    #tabela_dados, .tabela-container {
      overflow-x: auto;
      max-width: 100%;
    }

    #tabela_dados table, .tabela-container table {
      min-width: 600px;
      width: max-content;
    }

    /* Visualizar com 2 colunas e largura 50% cada */
    #tabela_dados table {
      width: 100% !important;
      table-layout: fixed;
    }
    #tabela_dados th, #tabela_dados td {
      width: 50%;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
<div id="form-container">
  <h1>Formulário</h1>

  <!-- Campos -->
  <label for="latitude">Latitude</label>
  <input type="text" id="latitude" readonly />

  <label for="longitude">Longitude</label>
  <input type="text" id="longitude" readonly />

  <label for="data_ocorrencia">Data da Ocorrência</label>
  <input type="text" id="data_ocorrencia" readonly />

  <label for="hora_ocorrencia">Hora da Ocorrência</label>
  <input type="text" id="hora_ocorrencia" readonly />

  <button id="btn-coords">Obter coordenadas e data/hora</button>

  <label for="re_militar">RE do Militar</label>
  <input type="number" id="re_militar" />

  <label for="posto_graduacao">Posto/Graduação</label>
  <input type="text" id="posto_graduacao" />

  <label for="nome_guerra">Nome de Guerra</label>
  <input type="text" id="nome_guerra" />

  <label for="obm_origem">OBM de Origem</label>
  <input type="text" id="obm_origem" />

  <label for="email">E-mail</label>
  <input type="email" id="email" />

  <label for="celular">Celular</label>
  <input type="tel" id="celular" maxlength="16" placeholder="(69) 9 XXXX-XXXX" />

  <label for="unidade_operacional">Unidade Operacional</label>
  <input type="text" id="unidade_operacional" />

  <label for="municipio">Município</label>
  <input type="text" id="municipio" />

  <label for="tipo_escala">Tipo da Escala</label>
  <input type="text" id="tipo_escala" />

  <label for="zona_atuacao">Zona de Atuação</label>
  <input type="text" id="zona_atuacao" />

  <label for="area_atuacao">Área de Atuação</label>
  <input type="text" id="area_atuacao" />

  <label for="tipo_ocorrencia">Tipo de Ocorrência</label>
  <input type="text" id="tipo_ocorrencia" />

  <label for="atuacao_gcif">Atuação GCIF</label>
  <input type="text" id="atuacao_gcif" />

  <label for="animais_mortos">Animais Mortos</label>
  <input type="number" id="animais_mortos" />

  <label for="animais_resgatados">Animais Resgatados</label>
  <input type="number" id="animais_resgatados" />

  <label for="multas_aplicadas">Multas Aplicadas</label>
  <input type="number" id="multas_aplicadas" />

  <label for="valor_multas">Valor Total das Multas (R$)</label>
  <input type="text" id="valor_multas" placeholder="R$ 0,00" />

  <label for="publico_alvo">Público Alvo</label>
  <input type="number" id="publico_alvo" />

  <label for="protocolo_siseg">Protocolo SISEG</label>
  <input type="number" id="protocolo_siseg" />

  <label for="qnt_siseg">QNT SISEG</label>
  <input type="number" id="qnt_siseg" />

  <label for="equipes">Equipes</label>
  <input type="text" id="equipes" />

  <label for="observacoes">Observações</label>
  <textarea id="observacoes" rows="3"></textarea>

  <!-- Botões -->
  <div id="botoes-final">
    <button id="btn-visualizar">Visualizar</button>
    <button id="btn-adicionar">Adicionar</button>
    <button id="btn-exportar">Exportar Excel</button>
    <button id="btn-limpar">Limpar Formulário</button>
    <button id="btn-limpar-dados">Limpar Dados Adicionados</button>
  </div>

  <!-- Visualização -->
  <div id="tabela_dados"></div>

  <!-- Tabela dinâmica de dados adicionados -->
  <div class="tabela-container">
    <h2>Dados Adicionados</h2>
    <table id="tabela-adicionados">
      <thead></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
  const camposOrdem = [
    "latitude", "longitude", "data_ocorrencia", "hora_ocorrencia","re_militar",
    "posto_graduacao", "nome_guerra", "obm_origem",
    "email", "celular", "unidade_operacional", "municipio",
    "tipo_escala", "zona_atuacao", "area_atuacao", "tipo_ocorrencia",
    "atuacao_gcif", "animais_mortos", "animais_resgatados",
    "multas_aplicadas", "valor_multas", "publico_alvo",
    "protocolo_siseg", "qnt_siseg", "equipes", "observacoes"
  ];

  const dadosForm = [];
  let dadosVisualizados = null;

  const formatarLabel = campo => ({
    latitude: "Latitude",
    longitude: "Longitude",
    data_ocorrencia: "Data da Ocorrência",
    hora_ocorrencia: "Hora da Ocorrência",
    re_militar: "RE do Militar",
    posto_graduacao: "Posto/Graduação",
    nome_guerra: "Nome de Guerra",
    obm_origem: "OBM de Origem",
    email: "E-mail",
    celular: "Celular",
    unidade_operacional: "Unidade Operacional",
    municipio: "Município",
    tipo_escala: "Tipo da Escala",
    zona_atuacao: "Zona de Atuação",
    area_atuacao: "Área de Atuação",
    tipo_ocorrencia: "Tipo de Ocorrência",
    atuacao_gcif: "Atuação GCIF",
    animais_mortos: "Animais Mortos",
    animais_resgatados: "Animais Resgatados",
    multas_aplicadas: "Multas Aplicadas",
    valor_multas: "Valor Total das Multas (R$)",
    publico_alvo: "Público Alvo",
    protocolo_siseg: "Protocolo SISEG",
    qnt_siseg: "QNT SISEG",
    equipes: "Equipes",
    observacoes: "Observações"
  }[campo] || campo);

  document.getElementById("valor_multas").addEventListener("input", function () {
    let v = this.value.replace(/\D/g, "");
    v = (parseInt(v) / 100).toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    this.value = v;
  });

  document.getElementById("celular").addEventListener("input", function () {
    let v = this.value.replace(/\D/g, "").slice(0, 11);
    let r = "";
    if (v.length > 0) r += `(${v.substring(0, 2)}`;
    if (v.length >= 3) r += `) ${v[2]} `;
    if (v.length >= 7) r += `${v.substring(3, 7)}-${v.substring(7)}`;
    else if (v.length > 3) r += v.substring(3);
    this.value = r;
  });

  document.getElementById("btn-coords").addEventListener("click", () => {
    const now = new Date();
    document.getElementById("data_ocorrencia").value = now.toLocaleDateString('pt-BR');
    document.getElementById("hora_ocorrencia").value = now.toLocaleTimeString('pt-BR');

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          document.getElementById("latitude").value = pos.coords.latitude.toFixed(7);
          document.getElementById("longitude").value = pos.coords.longitude.toFixed(7);
        },
        () => alert("Não foi possível obter a localização.")
      );
    } else {
      alert("Geolocalização não suportada neste navegador.");
    }
  });

  function limparFormulario() {
    camposOrdem.forEach(campo => document.getElementById(campo).value = "");
  }

  function montarTabelaVisualizar(dados) {
    if (!dados) return;

    let html = "<table><tbody>";
    camposOrdem.forEach(campo => {
      const label = formatarLabel(campo);
      let valor = dados[campo] || "";
      html += `<tr><th>${label}</th><td>${valor}</td></tr>`;
    });
    html += "</tbody></table>";
    document.getElementById("tabela_dados").innerHTML = html;
  }

  function montarTabelaAdicionados() {
    const thead = document.querySelector("#tabela-adicionados thead");
    const tbody = document.querySelector("#tabela-adicionados tbody");

    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (dadosForm.length === 0) {
      thead.innerHTML = "<tr><th>Nenhum dado adicionado ainda.</th></tr>";
      return;
    }

    // Cabeçalho
    let headerHtml = "<tr>";
    camposOrdem.forEach(campo => {
      headerHtml += `<th>${formatarLabel(campo)}</th>`;
    });
    headerHtml += "</tr>";
    thead.innerHTML = headerHtml;

    // Linhas
    dadosForm.forEach(linha => {
      let rowHtml = "<tr>";
      camposOrdem.forEach(campo => {
        rowHtml += `<td>${linha[campo] || ""}</td>`;
      });
      rowHtml += "</tr>";
      tbody.innerHTML += rowHtml;
    });
  }

  document.getElementById("btn-visualizar").addEventListener("click", () => {
    const dados = {};
    camposOrdem.forEach(campo => {
      dados[campo] = document.getElementById(campo).value.trim();
    });
    dadosVisualizados = dados;
    montarTabelaVisualizar(dadosVisualizados);
  });

  document.getElementById("btn-adicionar").addEventListener("click", () => {
    if (!dadosVisualizados) {
      alert("Visualize os dados antes de adicionar.");
      return;
    }

    // Adiciona ao array
    dadosForm.push(dadosVisualizados);

    // Mostra dados adicionados em linha (uma linha, vários campos)
    montarTabelaAdicionados();

    // Limpa visualização, formulário e dadosVisualizados
    document.getElementById("tabela_dados").innerHTML = "";
    limparFormulario();
    dadosVisualizados = null;
  });

  document.getElementById("btn-limpar").addEventListener("click", () => {
    limparFormulario();
    document.getElementById("tabela_dados").innerHTML = "";
    dadosVisualizados = null;
  });

  document.getElementById("btn-limpar-dados").addEventListener("click", () => {
    if (confirm("Tem certeza que deseja limpar todos os dados adicionados?")) {
      dadosForm.length = 0;
      montarTabelaAdicionados();
    }
  });

  document.getElementById("btn-exportar").addEventListener("click", () => {
    if (dadosForm.length === 0) {
      alert("Nenhum dado para exportar.");
      return;
    }
    // Criar worksheet e workbook
    const ws = XLSX.utils.json_to_sheet(dadosForm, { header: camposOrdem });
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Dados");

    XLSX.writeFile(wb, "dados_formulario.xlsx");
  });

  montarTabelaAdicionados();
</script>
</body>
</html>
